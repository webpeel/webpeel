name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    name: Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        node-version: [20.x]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm install
      
      - name: Install Playwright browsers
        run: npx playwright install chromium
      
      - name: Build
        run: npm run build
      
      - name: Run tests
        run: npm test
      
      - name: Lint
        run: npm run lint
        if: runner.os == 'Linux'

  # ─── Quality gates (catches the issues the audit found) ───
  quality-gates:
    name: Quality gates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Build
        run: npm run build

      # Gate 1: MCP tool parity (local = hosted)
      - name: MCP tool parity check
        run: |
          LOCAL=$(grep -c "name: 'webpeel_" src/mcp/server.ts)
          HOSTED=$(grep -c "name: 'webpeel_" src/server/routes/mcp.ts)
          echo "Local MCP: $LOCAL tools, Hosted MCP: $HOSTED tools"
          if [ "$LOCAL" -ne "$HOSTED" ]; then
            echo "❌ MCP tool count mismatch! Local=$LOCAL, Hosted=$HOSTED"
            echo "Every tool must be in BOTH src/mcp/server.ts AND src/server/routes/mcp.ts"
            exit 1
          fi
          echo "✅ MCP parity: $LOCAL tools in both servers"

      # Gate 2: Dockerfile version matches package.json
      - name: Dockerfile version pin check
        run: |
          VERSION=$(node -p "require('./package.json').version")
          if grep -q "webpeel@$VERSION" Dockerfile.api; then
            echo "✅ Dockerfile.api pins webpeel@$VERSION"
          else
            PINNED=$(grep -o 'webpeel@[0-9.]*' Dockerfile.api || echo "none")
            echo "❌ Version mismatch: Dockerfile.api=$PINNED, package.json=v$VERSION"
            exit 1
          fi

      # Gate 3: No secrets in source (real secrets only, not format docs)
      - name: Secret leak check
        run: |
          LEAKED=$(grep -rEn 'rnd_[A-Za-z0-9]{15,}|sk-ant-api[A-Za-z0-9]{10,}|npg_[A-Za-z0-9]{10,}' \
            src/ site/ README.md dashboard/src/ 2>/dev/null \
            | grep -v node_modules \
            | grep -v '\.env' \
            | grep -v 'example\|placeholder\|YOUR_KEY\|your_key\|xxx\|REDACTED\|abc123\|Format:' || true)
          if [ -n "$LEAKED" ]; then
            echo "❌ Possible secrets found in source code:"
            echo "$LEAKED"
            exit 1
          fi
          echo "✅ No secrets detected"

      # Gate 4: No stale marketing numbers
      - name: Content consistency check
        run: |
          TOOL_COUNT=$(grep -c "name: 'webpeel_" src/mcp/server.ts)
          STALE=0

          # Check for OLD tool counts in marketing (anything below current)
          for old in 7 11 12 13 14 15 16 17; do
            if [ "$old" -lt "$TOOL_COUNT" ]; then
              FOUND=$(grep -rn "\b${old} tool\|\b${old} MCP" site/index.html site/blog/ README.md llms.txt 2>/dev/null | grep -v CHANGELOG | grep -v node_modules || true)
              if [ -n "$FOUND" ]; then
                echo "⚠️  Found '${old} tools' (current: ${TOOL_COUNT}):"
                echo "$FOUND"
                STALE=1
              fi
            fi
          done

          # Check for old free tier (125/week)
          OLD_TIER=$(grep -rn "125/week\|125 per week\|125 free" site/ README.md 2>/dev/null | grep -v CHANGELOG | grep -v node_modules || true)
          if [ -n "$OLD_TIER" ]; then
            echo "⚠️  Found stale free tier (should be 500/week):"
            echo "$OLD_TIER"
            STALE=1
          fi

          if [ "$STALE" -eq 1 ]; then
            echo ""
            echo "❌ Stale content detected. Update ALL marketing to match current values."
            exit 1
          fi
          echo "✅ Content consistent: $TOOL_COUNT tools, 500/week"

      # Gate 5: Auth test — every route file must reference auth middleware
      - name: Auth coverage check
        run: |
          UNAUTHED=""
          for route in src/server/routes/*.ts; do
            BASENAME=$(basename "$route" .ts)
            # Skip health (intentionally public) and static/public routes
            if [[ "$BASENAME" == "health" || "$BASENAME" == "index" || "$BASENAME" == "webhooks" ]]; then
              continue
            fi
            if ! grep -q "auth\|requireAuth\|jwtAuth\|apiKeyAuth" "$route" 2>/dev/null; then
              UNAUTHED="$UNAUTHED $BASENAME"
            fi
          done
          if [ -n "$UNAUTHED" ]; then
            echo "❌ Routes without auth middleware:$UNAUTHED"
            echo "Every route must reference auth. If intentionally public, add a comment: // AUTH: public (reason)"
            exit 1
          fi
          echo "✅ All routes reference auth middleware"

  docker-validate:
    name: Validate Docker build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify Dockerfile.api exists and is referenced
        run: |
          test -f Dockerfile.api || (echo "❌ Dockerfile.api missing!" && exit 1)
          if [ -f Dockerfile ] && ! grep -q "mcp" Dockerfile 2>/dev/null; then
            echo "⚠️ Root Dockerfile exists and may not be the MCP variant"
          fi

      - name: Build Docker image
        run: docker build -f Dockerfile.api -t webpeel-api-test .

      - name: Smoke test Docker container
        run: |
          docker run -d --name wp-test -p 3333:3000 \
            -e JWT_SECRET=test-secret-for-ci \
            -e DATABASE_URL=postgresql://skip:skip@localhost/skip \
            webpeel-api-test || true
          sleep 5
          if docker ps | grep -q wp-test; then
            echo "✅ Container started successfully"
          else
            echo "Container logs:"
            docker logs wp-test 2>&1 | tail -20
            echo "::warning::Container exited (expected if no DB)"
          fi
          docker rm -f wp-test 2>/dev/null || true

  dashboard-check:
    name: Dashboard TypeScript check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x

      - name: Install dashboard dependencies
        working-directory: dashboard
        run: npm install

      - name: TypeScript check
        working-directory: dashboard
        run: npx tsc --noEmit

  notify-failure:
    name: Notify on failure
    runs-on: ubuntu-latest
    needs: [test, quality-gates]
    if: failure()
    steps:
      - name: Notify Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_CI }}
        run: |
          curl -H "Content-Type: application/json" \
            -d "{\"content\": \"⚠️ **WebPeel CI failed** on \`${{ github.ref_name }}\` — ${{ github.event.head_commit.message || 'PR update' }}\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}>\"}" \
            "$DISCORD_WEBHOOK"
        if: env.DISCORD_WEBHOOK != ''
